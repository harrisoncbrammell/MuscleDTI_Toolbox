# Help for the function [<i>fiber_quantifier</i>](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Tractography-Functions/fiber_quantifier.m), v. 2.0.0

## Introduction

This help file contains information about
1) [Purpose of the program](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Help/Current%20Functions/Help-for-fiber_quantifier.md#1-purpose)
2) [Usage of the program](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Help/Current%20Functions/Help-for-fiber_quantifier.md#2-usage)
3) [Syntax](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Help/Current%20Functions/Help-for-fiber_quantifier.md#3-Syntax)
4) [Example Code](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Help/Current%20Functions/Help-for-fiber_quantifier.md#4-Example-Code)
5) [Acknowledgements](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Help/Current%20Functions/Help-for-fiber_quantifier.md#5-Acknowledgements)

## 1. Purpose
 
The function <i>fiber_quantifier</i> is used to calculate the muscle architectural parameters pennation angle, fiber tract length, and curvature in the MuscleDTI_Toolbox. 


## 2. Usage
The user inputs the fiber tracts generated by <i>fiber_track</i> or <i>fiber_smoother</i>, the aponeurosis mesh, and a structure with information about the DTI images and options for implementing the polynomial fitting routines.  Calculations are performed automatically, for tracts having six or more points.  The function returns: 1) matrices holding the pennation angles in degrees, curvature values in m<sup>-1</sup>, and cumulative fiber-tract distances in mm at each fiber-tracking point; 2) a version of fiber_all with {row column slice} coordinates converted to mm; 3) the number of points at which architectural calculations were made in each fiber tract (useful for calculating averages, etc.); and 4) an estimate of the aponeurosis area represented by each point on the aponeurosis mesh. Information about each measurement follows:

* <i>Fiber tract length</i>: this is measured by summing the inter-point distances along the tract.

* <i>Pennation</i>: The method for pennation measurements is essentially as described in [Lansdown et al, J Appl Physiol 2007](https://pubmed.ncbi.nlm.nih.gov/17446411/). The approach to measuring pennation angle traditionally used in ultrasound imaging is to manually specify the line tangent to a muscle fascicle at the point of its insertion into the aponeurosis and a second line tangent to the aponeurosis. The angle formed by these lines is measured. In Lansdown et al., this concept was extended into 3D space by defining the plane tangent to the seed point and its normal vector. Also, position vectors between the seed point and points along the tract were defined.  Pennation angle was defined as the complement to the angle formed by the normal vector and the position vectors. In the toolbox, this is modified slightly to calculate the normal vector as the cross product between two tangent lines to the seed point (one lying in the row direction of the aponeurosis mesh (if aponeurosis seeding is used) or the muscle line of action (if non-aponeurosis seeding methods are used) and one lying in the column direction). This change improves computational efficiency. The mechanical line of action is defined as the central axis along the longest direction of the muscle, determined by fitting 3rd-order polynomial functions through the row and column coordinates of each muscle slice's centroid, as a function of slice number.

* <i>Curvature</i>: The method for curvature measurements is described in [Damon et al, Magn Reson Imaging 2012](https://pubmed.ncbi.nlm.nih.gov/22503094/). Briefly, these use a discrete implementation of the Frenet-Serret equations. Specifically, the curvature K is defined in 

     dT/ds = K N
     
  where T is the tangent line to points along the curve, s is the step length between points, and N is the normal vector. In <i>fiber_quantifier</i>, K is calculated by multiplying each side of this equation by the Moore-Penrose pseudoinverse matrix of N.

 For curvature, the best results are obtained with polynomial-fitted fiber tracts, calculated using <i>fiber_fitter</i>. Fiber tract length and pennation angle  are unaffected by polynomial fitting.


## 3. Syntax

[angle_list, distance_list, curvature_list, fiber_all_mm, n_points, apo_area] = ...
    fiber_quantifier(fq_options, fiber_all, roi_mesh, mask);

The input arguments are:
 
* <i>fq_options</i>: A user-defined structure containing the following fields:

   <i>.dwi_res</i>: a three element vector with the FOV, (assumed to be the same for the x and y directions), in-plane matrix size, and the slice thickness. The FOV and slice thickness must be specified in mm.

   <i>.filt_kernel</i>: As noted above, the pennation angle calculation relies on the measurement of two tangent lines along the roi_mesh. When determining these lines, their slopes are median-filtered over an NxN window as a way to mitigate the effects of digitization errors. The size of the median filter is specified in filt_kernel; enter this as a single odd integer, e.g. fq_options.filt_kernel = N.  Note that median filtering results in a loss of edge information; the number of rows and columns that will be lost increases with the size of the filter kernel.
   
   <i>.mesh_units</i>:  A two-element string variable set to 'vx' if the units of the aponeurosis mesh are voxels and set to 'mm' if the aponeurosis mesh has units of mm. If set to 'vx', the fiber tracts are converted to units of mm prior to quantification.
   
   <i>.tract_units</i>: A two-element string variable set to 'vx' if the units of the fiber tracts are voxels and set to 'mm' if the fiber tracts have units of mm. If set to 'vx', the fiber tracts are converted to units of mm prior to quantification.

  <i>.seed_method</i>: The method used to seed the points, as described in [Damon et al, NMR Biomed 2025](https://analyticalsciencejournals.onlinelibrary.wiley.com/doi/10.1002/nbm.70163). The method must be
specified as a string. The options are:

   &ensp;-aponeurosis ('a'): A mesh reconstruction of the aponeurosis of muscle fiber insertion. If this method is used, the input argument roi_mesh must be included.

   &ensp;-column ('c'): Tracts are seeded in a user-specified column or columns of the image passing through the muscle mask. The selected column(s) should be included in the field ft_options.planes.

   &ensp;-row ('r'): Tracts are seeded in a user-specified row or rows of the image passing through the muscle mask. The selected rows should be included in the field ft_options.planes.

   &ensp;-slice ('s'): Tracts are seeded in a user-specified slice or slices of the image passing through the muscle mask. The selected slices should be included in the field ft_options.planes.

   &ensp;-voxels ('v'): Tracts are seeded in individual voxels. To seed points in every voxel in the image mask, set ft_options.skip_vxl to 1.  To seed every Nth voxel, set ft_options.skip to N.

* <i>fiber_all</i>: A 4D matrix containing the fiber tract points, with units of pixels (in X and Y) or slice number (in Z). This matrix could be substituted with fitted_fiber_all (the output of [<i>fiber_smoother</i>](https://github.com/bdamon/MuscleDTI_Toolbox/blob/master/Help/Current%20Functions/Help-for-fiber_smoother.md))

* <i>roi_mesh</i>: The mesh reconstruction of the aponeurosis that was used as the seed surface for fiber tracking, output from <i>define_roi</i>.
  
* <i>mask</i>: The binary image mask defining the muscle boundaries and used for fiber tracking, output from <i>define_muscle</i>.


The output arguments are:
* <i>angle_list</i>: The pennation angles, for fiber tracking point numbers 2-end. Pennation angles are reported in degrees.

* <i>distance_list</i>: Distances along the fiber tracts, for fiber tracking point numbers 1-end. Distances are reported in mm.

* <i>curvature_list</i>: The curvature values at each fiber tracking point, for fiber tracking point numbers starting at 2 and ending 3 points before the tract's end. The latter is to avoid abrupt changes in tract position.  Curvature values are reported in 1/m.

* <i>fiber_all_mm</i>: The fiber tract points converted to units of mm.

* <i>n_points</i>: A 3D matrix (rows x columns x 3) containing the number of points used to quantify length, pennation, and curvature in each tract

* <i>apo_area</i>: A 2D matrix (rows x columns) containing the amount of apoeurosis area represented by each fiber tract, if aponeurosis seeding is used


## 4. Example Code
The code below will measure fiber tract length, pennation angle, and curvature in fitted fiber tracts derived from DTI data have a matrix size of 192x192, a field of view of 192x192 mm, and a slice thickness of 7 mm; normal vectors to the seed points onteh aponeurosis mesh will be calcualted after smoothing the sloces over a 5x5 kernel:

%% Set options:

fq_options.dwi_res = [192 192 7];            %images have 192x192 FOV, 192x192 matrix, and 7 mm slice thickness

fq_options.filt_kernel = 5;                  %kernel size

fq_options.mesh_units = 'vx';                %mesh is in units of voxels

fq_options.tract_units = 'vx';               %tracts are in units of voxels; will be converted to mm for quantification

fq_options.seed_method = 'a';                %aponeurosis-based seeding was used and an roi mesh will be input

%% call the function:

angle_list, distance_list, curvature_list, fiber_all_mm, n_points, apo_area] = ...

   fiber_quantifier(fq_options, fiber_all, roi_mesh, mask);


## 5. Acknowledgements
 People: Zhaohua Ding, Adam Anderson, Anneriet Heemskerk
 
 Grant support: NIH/NIAMS R01 AR050101, NIH/NIAMS R01 AR073831

